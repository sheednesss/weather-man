---
phase: 04-web-frontend-mvp
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - web/src/features/markets/MarketCard.tsx
  - web/src/features/markets/MarketList.tsx
  - web/src/features/markets/MarketDetail.tsx
  - web/src/features/trading/TradeForm.tsx
  - web/src/features/portfolio/PositionCard.tsx
  - web/src/features/portfolio/PositionList.tsx
  - web/src/pages/Markets.tsx
  - web/src/pages/Market.tsx
  - web/src/pages/Portfolio.tsx
  - web/src/hooks/useTrade.ts
  - web/src/App.tsx
autonomous: false

must_haves:
  truths:
    - "User can see market cards with price and weather"
    - "User can click market to see detail view"
    - "User can buy YES/NO shares via trade form"
    - "User can view portfolio with all positions"
    - "Portfolio shows P&L for each position"
    - "Trade form shows transaction status (pending, confirming, success)"
  artifacts:
    - path: "web/src/features/markets/MarketCard.tsx"
      provides: "Market card with price display"
      min_lines: 30
    - path: "web/src/features/trading/TradeForm.tsx"
      provides: "Buy/sell form with transaction handling"
      contains: "useWriteContract"
    - path: "web/src/features/portfolio/PositionCard.tsx"
      provides: "Position display with P&L calculation"
      min_lines: 25
    - path: "web/src/hooks/useTrade.ts"
      provides: "Trading hook with transaction confirmation"
      exports: ["useBuy", "useSell"]
  key_links:
    - from: "web/src/features/trading/TradeForm.tsx"
      to: "PredictionMarket contract"
      via: "useWriteContract"
      pattern: "writeContract.*buy|sell"
    - from: "web/src/pages/Portfolio.tsx"
      to: "web/src/hooks/usePositions.ts"
      via: "hook call"
      pattern: "usePositions"
---

<objective>
Build the complete trading UI: market browsing with cards showing price and weather, market detail with trade form, portfolio view with positions and P&L. Includes human verification of the full trading flow.

Purpose: Enable users to browse markets, place trades, and track their portfolio - the core product experience
Output: Functional trading interface ready for testnet use
</objective>

<execution_context>
@/Users/rasheedelhindi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rasheedelhindi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-web-frontend-mvp/04-RESEARCH.md
@.planning/phases/04-web-frontend-mvp/04-01-SUMMARY.md
@.planning/phases/04-web-frontend-mvp/04-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create market browsing components</name>
  <files>
    web/src/features/markets/MarketCard.tsx
    web/src/features/markets/MarketList.tsx
    web/src/pages/Markets.tsx
  </files>
  <action>
Create web/src/features/markets/MarketCard.tsx:
```typescript
import { Link } from 'react-router-dom'
import { formatUnits } from 'viem'
import type { MarketWithWeather } from '@/types/market'
import { USDC_DECIMALS } from '@/lib/contracts'

interface MarketCardProps {
  market: MarketWithWeather
}

export function MarketCard({ market }: MarketCardProps) {
  // Calculate YES/NO prices (0-100 cents)
  const totalPool = BigInt(market.yesPool) + BigInt(market.noPool)
  const yesPrice = totalPool > 0n
    ? Number(BigInt(market.yesPool) * 100n / totalPool)
    : 50
  const noPrice = 100 - yesPrice

  // Format temperature bounds (stored scaled by 100)
  const formatTemp = (scaled: number) => (scaled / 100).toFixed(0)

  // Format resolution time
  const resolutionDate = new Date(Number(market.resolutionTime) * 1000)
  const isResolved = market.resolved

  return (
    <Link to={`/markets/${market.id}`}>
      <div className="border rounded-lg p-4 hover:shadow-lg transition-shadow bg-white">
        {/* City and weather */}
        <div className="flex justify-between items-start mb-3">
          <h3 className="font-semibold text-lg">{market.cityId}</h3>
          {market.weather && (
            <span className="text-sm text-gray-500">
              {market.weather.current.temperature}F - {market.weather.current.conditions}
            </span>
          )}
        </div>

        {/* Temperature bracket */}
        <p className="text-sm text-gray-600 mb-3">
          Will temperature be {formatTemp(market.lowerBound)}-{formatTemp(market.upperBound)}F?
        </p>

        {/* Price display */}
        <div className="flex justify-between items-center mb-3">
          <div className="text-center">
            <span className="text-green-600 font-bold text-xl">{yesPrice}c</span>
            <p className="text-xs text-gray-500">YES</p>
          </div>
          <div className="text-center">
            <span className="text-red-600 font-bold text-xl">{noPrice}c</span>
            <p className="text-xs text-gray-500">NO</p>
          </div>
        </div>

        {/* Volume and status */}
        <div className="flex justify-between text-xs text-gray-500">
          <span>Vol: ${formatUnits(BigInt(market.volume), USDC_DECIMALS)}</span>
          <span>{isResolved ? 'Resolved' : resolutionDate.toLocaleDateString()}</span>
        </div>
      </div>
    </Link>
  )
}
```

Create web/src/features/markets/MarketList.tsx:
```typescript
import { MarketCard } from './MarketCard'
import { useMarketsWithWeather } from '@/hooks/useMarketsWithWeather'

export function MarketList() {
  const { data: markets, isLoading, error } = useMarketsWithWeather()

  if (isLoading) {
    return <div className="text-center py-8">Loading markets...</div>
  }

  if (error) {
    return (
      <div className="text-center py-8 text-red-600">
        Failed to load markets. Is the indexer running?
      </div>
    )
  }

  if (!markets || markets.length === 0) {
    return (
      <div className="text-center py-8 text-gray-500">
        No markets yet. Markets will appear here once deployed.
      </div>
    )
  }

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      {markets.map((market) => (
        <MarketCard key={market.id} market={market} />
      ))}
    </div>
  )
}
```

Update web/src/pages/Markets.tsx:
```typescript
import { MarketList } from '@/features/markets/MarketList'

export function Markets() {
  return (
    <div className="py-6">
      <h1 className="text-2xl font-bold mb-6">Markets</h1>
      <p className="text-gray-600 mb-6">
        Browse prediction markets sorted by volume. Click a market to trade.
      </p>
      <MarketList />
    </div>
  )
}
```

Styling: Mobile-first grid (1 col mobile, 2 md, 3 lg). Cards have hover effects. Clear visual hierarchy.
  </action>
  <verify>
Navigate to /markets. Should show loading, then either markets or empty state. If indexer running with data, cards display with weather.
  </verify>
  <done>MarketCard shows price, weather, volume. MarketList fetches and displays grid. Markets page renders list with heading.</done>
</task>

<task type="auto">
  <name>Task 2: Create trading form and market detail</name>
  <files>
    web/src/hooks/useTrade.ts
    web/src/features/trading/TradeForm.tsx
    web/src/features/markets/MarketDetail.tsx
    web/src/pages/Market.tsx
    web/src/App.tsx
  </files>
  <action>
Create web/src/hooks/useTrade.ts:
```typescript
import { useWriteContract, useWaitForTransactionReceipt } from 'wagmi'
import { useQueryClient } from '@tanstack/react-query'
import { parseUnits } from 'viem'
import { predictionMarketAbi, USDC_DECIMALS } from '@/lib/contracts'

export function useBuy(marketAddress: `0x${string}`) {
  const queryClient = useQueryClient()
  const { data: hash, isPending, writeContract, error, reset } = useWriteContract()

  const { isLoading: isConfirming, isSuccess } = useWaitForTransactionReceipt({ hash })

  const buy = (isYes: boolean, amount: string) => {
    writeContract({
      address: marketAddress,
      abi: predictionMarketAbi,
      functionName: 'buy',
      args: [isYes, parseUnits(amount, USDC_DECIMALS)],
    })
  }

  // Invalidate queries on success
  if (isSuccess) {
    queryClient.invalidateQueries({ queryKey: ['markets'] })
    queryClient.invalidateQueries({ queryKey: ['positions'] })
    queryClient.invalidateQueries({ queryKey: ['markets-with-weather'] })
  }

  return { buy, isPending, isConfirming, isSuccess, error, hash, reset }
}

export function useSell(marketAddress: `0x${string}`) {
  const queryClient = useQueryClient()
  const { data: hash, isPending, writeContract, error, reset } = useWriteContract()

  const { isLoading: isConfirming, isSuccess } = useWaitForTransactionReceipt({ hash })

  const sell = (isYes: boolean, amount: string) => {
    writeContract({
      address: marketAddress,
      abi: predictionMarketAbi,
      functionName: 'sell',
      args: [isYes, parseUnits(amount, USDC_DECIMALS)],
    })
  }

  if (isSuccess) {
    queryClient.invalidateQueries({ queryKey: ['markets'] })
    queryClient.invalidateQueries({ queryKey: ['positions'] })
    queryClient.invalidateQueries({ queryKey: ['markets-with-weather'] })
  }

  return { sell, isPending, isConfirming, isSuccess, error, hash, reset }
}
```

Create web/src/features/trading/TradeForm.tsx:
```typescript
import { useState } from 'react'
import { useAccount } from 'wagmi'
import { ConnectButton } from '@rainbow-me/rainbowkit'
import { useBuy } from '@/hooks/useTrade'

interface TradeFormProps {
  marketAddress: `0x${string}`
  yesPrice: number
  noPrice: number
}

export function TradeForm({ marketAddress, yesPrice, noPrice }: TradeFormProps) {
  const { address, isConnected } = useAccount()
  const [amount, setAmount] = useState('')
  const [side, setSide] = useState<'yes' | 'no'>('yes')

  const { buy, isPending, isConfirming, isSuccess, error, reset } = useBuy(marketAddress)

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault()
    if (!amount || parseFloat(amount) <= 0) return
    buy(side === 'yes', amount)
  }

  const handleReset = () => {
    reset()
    setAmount('')
  }

  if (!isConnected) {
    return (
      <div className="border rounded-lg p-4 bg-gray-50">
        <p className="text-center text-gray-600 mb-4">Connect wallet to trade</p>
        <div className="flex justify-center">
          <ConnectButton />
        </div>
      </div>
    )
  }

  if (isSuccess) {
    return (
      <div className="border rounded-lg p-4 bg-green-50">
        <p className="text-center text-green-700 font-medium mb-4">Trade successful!</p>
        <button
          onClick={handleReset}
          className="w-full py-2 bg-gray-200 hover:bg-gray-300 rounded"
        >
          Make Another Trade
        </button>
      </div>
    )
  }

  return (
    <form onSubmit={handleSubmit} className="border rounded-lg p-4">
      <h3 className="font-semibold mb-4">Place Trade</h3>

      {/* Side selector */}
      <div className="flex gap-2 mb-4">
        <button
          type="button"
          onClick={() => setSide('yes')}
          className={`flex-1 py-3 rounded font-medium transition-colors ${
            side === 'yes'
              ? 'bg-green-600 text-white'
              : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
          }`}
        >
          YES @ {yesPrice}c
        </button>
        <button
          type="button"
          onClick={() => setSide('no')}
          className={`flex-1 py-3 rounded font-medium transition-colors ${
            side === 'no'
              ? 'bg-red-600 text-white'
              : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
          }`}
        >
          NO @ {noPrice}c
        </button>
      </div>

      {/* Amount input */}
      <div className="mb-4">
        <label className="block text-sm text-gray-600 mb-1">Amount (USDC)</label>
        <input
          type="number"
          value={amount}
          onChange={(e) => setAmount(e.target.value)}
          placeholder="10.00"
          step="0.01"
          min="0"
          className="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
      </div>

      {/* Estimated shares */}
      {amount && parseFloat(amount) > 0 && (
        <p className="text-sm text-gray-600 mb-4">
          Est. shares: {(parseFloat(amount) / (side === 'yes' ? yesPrice : noPrice) * 100).toFixed(2)}
        </p>
      )}

      {/* Submit button */}
      <button
        type="submit"
        disabled={isPending || isConfirming || !amount}
        className={`w-full py-3 rounded font-medium text-white transition-colors ${
          isPending || isConfirming
            ? 'bg-gray-400 cursor-not-allowed'
            : side === 'yes'
              ? 'bg-green-600 hover:bg-green-700'
              : 'bg-red-600 hover:bg-red-700'
        }`}
      >
        {isPending
          ? 'Confirm in wallet...'
          : isConfirming
            ? 'Confirming...'
            : `Buy ${side.toUpperCase()}`}
      </button>

      {/* Error display */}
      {error && (
        <p className="text-red-600 text-sm mt-2">
          {error.message.includes('User rejected')
            ? 'Transaction cancelled'
            : 'Transaction failed. Try again.'}
        </p>
      )}
    </form>
  )
}
```

Create web/src/features/markets/MarketDetail.tsx showing full market info + trade form.

Create web/src/pages/Market.tsx as route /markets/:id.

Update App.tsx routes to include:
```typescript
<Route path="markets/:id" element={<Market />} />
```
  </action>
  <verify>
Navigate to /markets/{marketId}. Trade form appears with YES/NO buttons, amount input, and submit button. Button shows correct states.
  </verify>
  <done>TradeForm handles buy with transaction states. MarketDetail shows full market info. Market page route works.</done>
</task>

<task type="auto">
  <name>Task 3: Create portfolio view with P&L</name>
  <files>
    web/src/features/portfolio/PositionCard.tsx
    web/src/features/portfolio/PositionList.tsx
    web/src/pages/Portfolio.tsx
  </files>
  <action>
Create web/src/features/portfolio/PositionCard.tsx:
```typescript
import { Link } from 'react-router-dom'
import { formatUnits } from 'viem'
import type { Position } from '@/types/position'
import type { Market } from '@/types/market'
import { USDC_DECIMALS } from '@/lib/contracts'

interface PositionCardProps {
  position: Position
  market?: Market  // Optional: for displaying market context
}

export function PositionCard({ position, market }: PositionCardProps) {
  const shares = formatUnits(BigInt(position.shares), USDC_DECIMALS)
  const costBasis = formatUnits(BigInt(position.costBasis), USDC_DECIMALS)

  // Calculate current value if market data available
  let currentValue = 0
  let pnl = 0
  let pnlPercent = 0

  if (market) {
    const totalPool = BigInt(market.yesPool) + BigInt(market.noPool)
    const price = totalPool > 0n
      ? Number(position.isYes
          ? BigInt(market.yesPool) * 100n / totalPool
          : BigInt(market.noPool) * 100n / totalPool
        ) / 100
      : 0.5

    currentValue = parseFloat(shares) * price
    pnl = currentValue - parseFloat(costBasis)
    pnlPercent = parseFloat(costBasis) > 0
      ? (pnl / parseFloat(costBasis)) * 100
      : 0
  }

  const pnlColor = pnl >= 0 ? 'text-green-600' : 'text-red-600'

  return (
    <Link to={`/markets/${position.marketId}`}>
      <div className="border rounded-lg p-4 hover:shadow-md transition-shadow bg-white">
        <div className="flex justify-between items-start mb-2">
          <div>
            <span className={`inline-block px-2 py-1 rounded text-sm font-medium ${
              position.isYes
                ? 'bg-green-100 text-green-800'
                : 'bg-red-100 text-red-800'
            }`}>
              {position.isYes ? 'YES' : 'NO'}
            </span>
            {market && (
              <span className="ml-2 text-gray-600">{market.cityId}</span>
            )}
          </div>
          <span className="text-sm text-gray-500">
            {parseFloat(shares).toFixed(2)} shares
          </span>
        </div>

        <div className="flex justify-between items-end">
          <div>
            <p className="text-xs text-gray-500">Cost Basis</p>
            <p className="font-medium">${parseFloat(costBasis).toFixed(2)}</p>
          </div>
          {market && (
            <div className="text-right">
              <p className="text-xs text-gray-500">P&L</p>
              <p className={`font-medium ${pnlColor}`}>
                {pnl >= 0 ? '+' : ''}{pnl.toFixed(2)} ({pnlPercent.toFixed(1)}%)
              </p>
            </div>
          )}
        </div>
      </div>
    </Link>
  )
}
```

Create web/src/features/portfolio/PositionList.tsx:
```typescript
import { useAccount } from 'wagmi'
import { ConnectButton } from '@rainbow-me/rainbowkit'
import { PositionCard } from './PositionCard'
import { usePositions } from '@/hooks/usePositions'
import { useMarkets } from '@/hooks/useMarkets'

export function PositionList() {
  const { isConnected } = useAccount()
  const { data: positions, isLoading: positionsLoading } = usePositions()
  const { data: markets } = useMarkets()

  if (!isConnected) {
    return (
      <div className="text-center py-12">
        <p className="text-gray-600 mb-4">Connect your wallet to view positions</p>
        <ConnectButton />
      </div>
    )
  }

  if (positionsLoading) {
    return <div className="text-center py-8">Loading positions...</div>
  }

  if (!positions || positions.length === 0) {
    return (
      <div className="text-center py-12 text-gray-500">
        <p className="mb-2">No positions yet</p>
        <p className="text-sm">Trade on markets to build your portfolio</p>
      </div>
    )
  }

  // Create market lookup for P&L calculations
  const marketMap = new Map(markets?.map(m => [m.id, m]) || [])

  // Calculate totals
  const totalCostBasis = positions.reduce(
    (sum, p) => sum + parseFloat(formatUnits(BigInt(p.costBasis), 6)),
    0
  )

  return (
    <div>
      {/* Portfolio summary */}
      <div className="bg-gray-50 rounded-lg p-4 mb-6">
        <div className="flex justify-between">
          <div>
            <p className="text-sm text-gray-500">Total Invested</p>
            <p className="text-xl font-bold">${totalCostBasis.toFixed(2)}</p>
          </div>
          <div className="text-right">
            <p className="text-sm text-gray-500">Positions</p>
            <p className="text-xl font-bold">{positions.length}</p>
          </div>
        </div>
      </div>

      {/* Position cards */}
      <div className="space-y-3">
        {positions.map((position) => (
          <PositionCard
            key={position.id}
            position={position}
            market={marketMap.get(position.marketId)}
          />
        ))}
      </div>
    </div>
  )
}
```

Update web/src/pages/Portfolio.tsx:
```typescript
import { PositionList } from '@/features/portfolio/PositionList'

export function Portfolio() {
  return (
    <div className="py-6">
      <h1 className="text-2xl font-bold mb-6">Portfolio</h1>
      <PositionList />
    </div>
  )
}
```

Import formatUnits from viem where needed.
  </action>
  <verify>
Navigate to /portfolio. When not connected, shows connect prompt. When connected with positions, shows position cards with P&L.
  </verify>
  <done>PositionCard displays shares, cost basis, and P&L. PositionList shows all positions with summary. Portfolio page renders list.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Verify complete trading flow</name>
  <what-built>
Complete web frontend MVP:
- Wallet connection via RainbowKit
- Market browsing with price and weather data
- Trading form for buying YES/NO shares
- Portfolio view with positions and P&L
- Mobile-responsive layout
  </what-built>
  <how-to-verify>
1. Start the indexer (if not running): `cd indexer-api && npm run dev`
2. Start the web app: `cd web && npm run dev`
3. Open http://localhost:5173 in browser

**Desktop verification:**
- [ ] Home page loads with hero and CTA
- [ ] Click "Connect Wallet" - RainbowKit modal opens
- [ ] Connect with test wallet (MetaMask/etc) on Base Sepolia
- [ ] Navigate to Markets - see market cards (or empty state if no markets)
- [ ] If markets exist: Click a market card - see detail page with trade form
- [ ] Select YES/NO, enter amount, click Buy - transaction flow works
- [ ] Navigate to Portfolio - see positions (or empty state)

**Mobile verification (resize to 375px):**
- [ ] Header shows hamburger menu
- [ ] Connect Wallet button still visible
- [ ] Market cards stack vertically
- [ ] Trade form is usable on mobile
- [ ] Portfolio layout adapts

**If markets aren't deployed yet:**
- App should show "No markets yet" gracefully
- All navigation and wallet connection should still work
- Portfolio shows "No positions yet" when connected
  </how-to-verify>
  <resume-signal>Type "approved" if flow works, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. Markets page shows grid of market cards with prices and weather
2. Clicking market navigates to detail with trade form
3. Trade form shows YES/NO selector, amount input, submit button
4. Transaction states (pending, confirming, success) display correctly
5. Portfolio page shows positions with cost basis and P&L
6. All pages are mobile-responsive
7. Empty states display appropriately when no data
</verification>

<success_criteria>
- [ ] MarketCard displays price (YES/NO cents), weather, volume
- [ ] MarketList fetches from API and displays grid
- [ ] TradeForm handles buy transaction with all states
- [ ] PositionCard shows shares, cost basis, P&L
- [ ] PositionList shows all user positions when connected
- [ ] Market detail page exists at /markets/:id
- [ ] Mobile layout works at 375px viewport
- [ ] Human verified complete trading flow
</success_criteria>

<output>
After completion, create `.planning/phases/04-web-frontend-mvp/04-03-SUMMARY.md`
</output>
