---
phase: 02-oracle-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - oracle-service/package.json
  - oracle-service/tsconfig.json
  - oracle-service/.env.example
  - oracle-service/src/config/env.ts
  - oracle-service/src/config/constants.ts
  - oracle-service/src/types/weather.ts
  - oracle-service/src/types/market.ts
  - oracle-service/src/utils/logger.ts
  - oracle-service/src/utils/retry.ts
  - oracle-service/src/providers/openweathermap.ts
  - oracle-service/src/providers/openmeteo.ts
  - oracle-service/src/providers/tomorrow.ts
autonomous: true
user_setup:
  - service: openweathermap
    why: "Weather data source 1 of 3"
    env_vars:
      - name: OPENWEATHERMAP_API_KEY
        source: "https://openweathermap.org/api -> Sign up -> API keys"
  - service: tomorrow.io
    why: "Weather data source 3 of 3"
    env_vars:
      - name: TOMORROW_API_KEY
        source: "https://www.tomorrow.io/weather-api/ -> Sign up -> Dashboard -> API key"

must_haves:
  truths:
    - "Oracle service project exists with TypeScript configuration"
    - "All 3 weather API clients can fetch temperature data"
    - "Environment validation fails fast on missing config"
  artifacts:
    - path: "oracle-service/package.json"
      provides: "Node.js project with dependencies"
      contains: "ethers|axios|node-cron"
    - path: "oracle-service/src/config/env.ts"
      provides: "Environment validation"
      contains: "cleanEnv|OPENWEATHERMAP_API_KEY|TOMORROW_API_KEY"
    - path: "oracle-service/src/providers/openweathermap.ts"
      provides: "OpenWeatherMap API client"
      exports: ["fetchFromOpenWeatherMap"]
    - path: "oracle-service/src/providers/openmeteo.ts"
      provides: "Open-Meteo API client"
      exports: ["fetchFromOpenMeteo"]
    - path: "oracle-service/src/providers/tomorrow.ts"
      provides: "Tomorrow.io API client"
      exports: ["fetchFromTomorrowIo"]
  key_links:
    - from: "oracle-service/src/providers/*.ts"
      to: "oracle-service/src/utils/retry.ts"
      via: "axios client with retry"
      pattern: "createRetryClient|retryClient"
    - from: "oracle-service/src/providers/*.ts"
      to: "oracle-service/src/types/weather.ts"
      via: "TemperatureReading type"
      pattern: "TemperatureReading"
---

<objective>
Set up the oracle service TypeScript project with weather API clients.

Purpose: Create the foundation for the oracle service - a Node.js/TypeScript project that fetches weather data from 3 API sources. This plan establishes project structure, configurations, types, and individual API clients. The actual aggregation and blockchain integration comes in Plan 03.

Output: oracle-service/ directory with working TypeScript project, 3 weather API provider clients, env validation, logging, retry utilities.
</objective>

<execution_context>
@/Users/rasheedelhindi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rasheedelhindi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-oracle-infrastructure/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize oracle-service TypeScript project</name>
  <files>
    oracle-service/package.json
    oracle-service/tsconfig.json
    oracle-service/.env.example
    oracle-service/.gitignore
  </files>
  <action>
Create oracle-service directory at project root (sibling to contracts/).

**package.json:**
```json
{
  "name": "weather-oracle-service",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "build": "tsc",
    "start": "node dist/index.js",
    "dev": "tsx watch src/index.ts",
    "test": "jest"
  },
  "dependencies": {
    "ethers": "^6.13.0",
    "axios": "^1.7.0",
    "axios-retry": "^4.4.0",
    "node-cron": "^3.0.3",
    "envalid": "^8.0.0",
    "winston": "^3.13.0"
  },
  "devDependencies": {
    "typescript": "^5.5.0",
    "@types/node": "^20.14.0",
    "@types/node-cron": "^3.0.11",
    "tsx": "^4.16.0",
    "jest": "^29.7.0",
    "ts-jest": "^29.2.0",
    "@types/jest": "^29.5.0"
  }
}
```

**tsconfig.json:**
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "NodeNext",
    "moduleResolution": "NodeNext",
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "resolveJsonModule": true,
    "declaration": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

**.env.example:**
```
# Blockchain
BASE_RPC_URL=https://sepolia.base.org
ORACLE_PRIVATE_KEY=0x...your_private_key...
MARKET_FACTORY_ADDRESS=0x...deployed_factory_address...

# Weather APIs
OPENWEATHERMAP_API_KEY=your_openweathermap_key
TOMORROW_API_KEY=your_tomorrow_io_key
# Open-Meteo requires no API key

# Config
NODE_ENV=development
```

**.gitignore:**
```
node_modules/
dist/
.env
*.log
```

Run: `cd oracle-service && npm install`
  </action>
  <verify>cd oracle-service && npm install && npx tsc --noEmit (no compilation errors)</verify>
  <done>oracle-service project initialized with all dependencies installed</done>
</task>

<task type="auto">
  <name>Task 2: Create config, types, and utility modules</name>
  <files>
    oracle-service/src/config/env.ts
    oracle-service/src/config/constants.ts
    oracle-service/src/types/weather.ts
    oracle-service/src/types/market.ts
    oracle-service/src/utils/logger.ts
    oracle-service/src/utils/retry.ts
  </files>
  <action>
**src/config/env.ts** - Environment validation using envalid:
- BASE_RPC_URL: url (required)
- ORACLE_PRIVATE_KEY: str (required, starts with 0x)
- MARKET_FACTORY_ADDRESS: str (required, starts with 0x)
- OPENWEATHERMAP_API_KEY: str (required)
- TOMORROW_API_KEY: str (required)
- NODE_ENV: str (choices: development, production, test; default: development)

**src/config/constants.ts** - City coordinates and API endpoints:
- CITIES object with NYC, CHICAGO, MIAMI, AUSTIN - each has name, lat, lon (as numbers, e.g., 40.7128)
- CityId type union: 'NYC' | 'CHICAGO' | 'MIAMI' | 'AUSTIN'
- API endpoint constants for the 3 weather providers

**src/types/weather.ts:**
```typescript
export interface TemperatureReading {
  source: string;
  temperature: number; // Fahrenheit
  timestamp: number;   // Unix ms
}

export interface AggregatedTemperature {
  median: number;
  sources: number;
  readings: TemperatureReading[];
}
```

**src/types/market.ts:**
```typescript
export interface MarketConfig {
  conditionId: string;
  questionId: string;
  city: CityId;
  resolutionTime: Date;
  lowerBound: number; // Temperature bracket lower bound (F)
  upperBound: number; // Temperature bracket upper bound (F)
}

export interface ResolutionResult {
  conditionId: string;
  temperature: number;
  outcome: 'YES' | 'NO';
  txHash: string;
}
```

**src/utils/logger.ts** - Winston logger:
- Console transport with timestamp and colorization
- Log level based on NODE_ENV (debug in dev, info in prod)
- Export logger instance

**src/utils/retry.ts** - Axios retry client:
- Create axios instance with 10s timeout
- Configure axios-retry: 3 retries, exponential backoff, retry on network errors and 429/5xx
- Export createRetryClient function
  </action>
  <verify>cd oracle-service && npx tsc --noEmit (TypeScript compiles)</verify>
  <done>Config, types, and utilities exist with proper typing</done>
</task>

<task type="auto">
  <name>Task 3: Implement 3 weather API provider clients</name>
  <files>
    oracle-service/src/providers/openweathermap.ts
    oracle-service/src/providers/openmeteo.ts
    oracle-service/src/providers/tomorrow.ts
    oracle-service/src/providers/index.ts
  </files>
  <action>
Each provider file exports an async function that:
- Takes city coordinates (lat, lon) and API key (if needed)
- Returns TemperatureReading | null (null on failure)
- Uses the retry client from utils/retry.ts
- Catches errors and logs them, never throws

**src/providers/openweathermap.ts:**
```typescript
export async function fetchFromOpenWeatherMap(
  cityName: string,
  apiKey: string
): Promise<TemperatureReading | null>
```
- Endpoint: https://api.openweathermap.org/data/2.5/weather?q={city}&appid={key}&units=imperial
- Response: data.main.temp (already in Fahrenheit with units=imperial)

**src/providers/openmeteo.ts:**
```typescript
export async function fetchFromOpenMeteo(
  lat: number,
  lon: number
): Promise<TemperatureReading | null>
```
- Endpoint: https://api.open-meteo.com/v1/forecast?latitude={lat}&longitude={lon}&current=temperature_2m&temperature_unit=fahrenheit
- Response: data.current.temperature_2m
- No API key required

**src/providers/tomorrow.ts:**
```typescript
export async function fetchFromTomorrowIo(
  lat: number,
  lon: number,
  apiKey: string
): Promise<TemperatureReading | null>
```
- Endpoint: https://api.tomorrow.io/v4/weather/realtime?location={lat},{lon}&apikey={key}&units=imperial
- Response: data.data.values.temperature

**src/providers/index.ts** - Re-export all providers:
```typescript
export { fetchFromOpenWeatherMap } from './openweathermap.js';
export { fetchFromOpenMeteo } from './openmeteo.js';
export { fetchFromTomorrowIo } from './tomorrow.js';
```
  </action>
  <verify>cd oracle-service && npx tsc --noEmit (all providers compile)</verify>
  <done>All 3 weather API clients implemented with consistent interface</done>
</task>

</tasks>

<verification>
- `cd oracle-service && npm install` succeeds
- `cd oracle-service && npx tsc` compiles without errors
- All 3 provider files exist with exported fetch functions
- env.ts validates all required environment variables
- Types are properly defined for weather readings and markets
</verification>

<success_criteria>
- oracle-service/ directory exists as sibling to contracts/
- TypeScript compiles without errors
- All dependencies installed (ethers, axios, node-cron, etc.)
- 3 weather provider clients ready for use (actual API calls tested in integration)
- Environment validation catches missing config at startup
</success_criteria>

<output>
After completion, create `.planning/phases/02-oracle-infrastructure/02-02-SUMMARY.md`
</output>
