---
phase: 01-smart-contract-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - contracts/script/Deploy.s.sol
  - contracts/.env
  - contracts/deployments/base-sepolia.json
autonomous: false

user_setup:
  - service: base-sepolia
    why: "Testnet deployment requires funded wallet"
    env_vars:
      - name: PRIVATE_KEY
        source: "Export from MetaMask/wallet - needs Base Sepolia ETH for gas"
      - name: BASE_SEPOLIA_RPC
        source: "Use https://sepolia.base.org or Alchemy/Infura endpoint"
    dashboard_config:
      - task: "Fund deployer wallet with Base Sepolia ETH"
        location: "https://www.alchemy.com/faucets/base-sepolia or bridge from Sepolia"

must_haves:
  truths:
    - "Contracts are deployed and verified on Base Sepolia"
    - "Deployment addresses are recorded for frontend integration"
    - "Contracts are callable by any wallet on Base Sepolia (enables WALLET-01 in Phase 4)"
  artifacts:
    - path: "contracts/script/Deploy.s.sol"
      provides: "Deployment script for all contracts"
      exports: ["run"]
    - path: "contracts/deployments/base-sepolia.json"
      provides: "Deployed contract addresses"
      contains: "MarketFactory"
  key_links:
    - from: "contracts/script/Deploy.s.sol"
      to: "Base Sepolia RPC"
      via: "forge script --rpc-url"
      pattern: "vm.startBroadcast"
    - from: "contracts/deployments/base-sepolia.json"
      to: "Phase 4 frontend"
      via: "Address import for wagmi/viem"
      pattern: "address"

# Scoping note for WALLET-01:
# WALLET-01 (User can connect wallet) is a frontend requirement.
# Phase 1 ENABLES this by deploying contracts that wallets can interact with.
# Actual wallet connection UI is implemented in Phase 4 (frontend).
# This is acceptable scoping: Phase 1 = contracts, Phase 4 = wallet UI.
---

<objective>
Create deployment scripts, deploy all contracts to Base Sepolia testnet, verify on BaseScan, and record deployment addresses for frontend integration.

Purpose: Makes contracts available on a real network. Enables Phase 4 frontend to connect to deployed contracts. Validates that contracts work on actual EVM. Note: WALLET-01 (wallet connection UI) is deferred to Phase 4 - this phase provides the contracts that wallets will connect TO.
Output: Deployed, verified contracts on Base Sepolia with recorded addresses.
</objective>

<execution_context>
@/Users/rasheedelhindi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rasheedelhindi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-smart-contract-foundation/01-RESEARCH.md
@.planning/phases/01-smart-contract-foundation/01-01-SUMMARY.md
@.planning/phases/01-smart-contract-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create deployment script</name>
  <files>
    contracts/script/Deploy.s.sol
    contracts/script/DeployLocal.s.sol
  </files>
  <action>
Create `contracts/script/Deploy.s.sol`:
```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import {Script, console} from "forge-std/Script.sol";
import {Vault} from "../src/Vault.sol";
import {MarketFactory} from "../src/MarketFactory.sol";

contract DeployScript is Script {
    // Base Sepolia USDC address
    address constant USDC = 0x036cbd53842c5426634e7929541ec2318f3dcf7e;

    function run() external {
        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");

        vm.startBroadcast(deployerPrivateKey);

        // Deploy Vault for USDC custody
        Vault vault = new Vault(USDC);
        console.log("Vault deployed at:", address(vault));

        // For MVP, we need CTF address. Options:
        // 1. Deploy our own CTF (if not on Base Sepolia)
        // 2. Use existing CTF deployment
        // For now, assume CTF needs to be deployed or use a mock

        // Deploy MarketFactory
        // Note: CTF address needed - this may require deploying CTF first
        // or using an existing deployment
        address ctfAddress = vm.envOr("CTF_ADDRESS", address(0));

        if (ctfAddress == address(0)) {
            console.log("Warning: CTF_ADDRESS not set. MarketFactory not deployed.");
            console.log("Deploy CTF first or set CTF_ADDRESS in .env");
        } else {
            MarketFactory factory = new MarketFactory(ctfAddress, USDC);
            console.log("MarketFactory deployed at:", address(factory));
        }

        vm.stopBroadcast();
    }
}
```

Create `contracts/script/DeployLocal.s.sol` for local Anvil testing:
- Deploys mock USDC
- Deploys mock or simplified CTF
- Deploys Vault and MarketFactory
- Creates a test market
- Useful for local development before testnet deployment

Also update foundry.toml to add:
```toml
[etherscan]
base_sepolia = { key = "${BASESCAN_API_KEY}", url = "https://api-sepolia.basescan.org/api", chain = 84532 }
```
  </action>
  <verify>
Run `cd contracts && forge build` - scripts compile.
Run `cd contracts && forge script script/Deploy.s.sol --dry-run` - dry run succeeds (may warn about CTF).
  </verify>
  <done>
Deployment scripts ready for testnet and local deployment.
  </done>
</task>

<task type="auto">
  <name>Task 2: Deploy to Base Sepolia and create test market</name>
  <files>
    contracts/.env
    contracts/deployments/base-sepolia.json
  </files>
  <action>
First, check if Gnosis CTF is deployed on Base Sepolia:
- Search BaseScan for ConditionalTokens contract
- If not deployed, we have two options:
  a) Deploy the Gnosis CTF contracts ourselves
  b) Use a simplified in-house conditional token for MVP

For MVP simplicity, if CTF is not on Base Sepolia, create a simplified version:
Create `contracts/src/SimpleConditionalTokens.sol`:
- Implements IConditionalTokens interface
- Uses ERC-1155 from OpenZeppelin
- Simpler than full CTF but sufficient for binary outcomes
- Can be replaced with real CTF later

Deploy sequence:
1. Copy `.env.example` to `.env`, fill in PRIVATE_KEY and RPC
2. Run deployment:
```bash
cd contracts
source .env
forge script script/Deploy.s.sol:DeployScript \
  --rpc-url $BASE_SEPOLIA_RPC \
  --broadcast \
  --verify \
  -vvvv
```

3. After deployment, create `contracts/deployments/base-sepolia.json`:
```json
{
  "chainId": 84532,
  "network": "base-sepolia",
  "deployedAt": "<timestamp>",
  "contracts": {
    "Vault": {
      "address": "<deployed-address>",
      "txHash": "<deployment-tx>"
    },
    "MarketFactory": {
      "address": "<deployed-address>",
      "txHash": "<deployment-tx>"
    },
    "ConditionalTokens": {
      "address": "<deployed-or-existing-address>",
      "txHash": "<if-we-deployed>"
    }
  },
  "usdc": "0x036cbd53842c5426634e7929541ec2318f3dcf7e"
}
```

4. Create a test market for verification:
```bash
# Using cast to interact with deployed MarketFactory
cast send <FACTORY_ADDRESS> \
  "createMarket(bytes32,uint256)" \
  0x1234...questionId \
  $(date -v+7d +%s) \
  --rpc-url $BASE_SEPOLIA_RPC \
  --private-key $PRIVATE_KEY
```
  </action>
  <verify>
Check BaseScan for deployed contracts - should show verified source code.
Run `cast call <VAULT_ADDRESS> "usdc()" --rpc-url $BASE_SEPOLIA_RPC` - returns USDC address.
Run `cast call <FACTORY_ADDRESS> "marketCount()" --rpc-url $BASE_SEPOLIA_RPC` - returns >= 1 if test market created.
  </verify>
  <done>
Contracts deployed to Base Sepolia. Test market created. Addresses recorded in deployments JSON. Any wallet on Base Sepolia can now interact with these contracts (enabling WALLET-01 in Phase 4).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Smart contracts deployed to Base Sepolia testnet:
    - Vault contract for USDC deposit/withdraw
    - MarketFactory for creating prediction markets
    - ConditionalTokens (CTF or simplified version)
    - One test market created

    Note: These contracts are now publicly accessible on Base Sepolia.
    WALLET-01 (wallet connection UI) will be implemented in Phase 4 frontend.
    This deployment enables that future work.
  </what-built>
  <how-to-verify>
    1. Open contracts/deployments/base-sepolia.json and note the addresses
    2. Visit https://sepolia.basescan.org
    3. Search for Vault address - verify source code is verified and readable
    4. Search for MarketFactory address - verify source code is verified
    5. Check the test market creation transaction succeeded
    6. (Optional) Try interacting via BaseScan "Write Contract":
       - Approve USDC to Vault
       - Deposit small amount (need testnet USDC)
       - Check balance increased
  </how-to-verify>
  <resume-signal>Type "approved" if contracts are verified on BaseScan, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. `contracts/script/Deploy.s.sol` exists and compiles
2. `contracts/deployments/base-sepolia.json` contains valid addresses
3. Contracts appear as verified on BaseScan
4. MarketFactory has at least 1 market created (marketCount >= 1)
5. Vault contract is connected to correct USDC address
6. Contracts are publicly callable (no access restrictions blocking wallet interaction)
</verification>

<success_criteria>
- Deployment script handles both testnet and local deployment
- All contracts deployed to Base Sepolia
- Contract source code verified on BaseScan
- Test market created and queryable
- Deployment addresses recorded in JSON for frontend
- User has verified deployment via BaseScan
- Contracts are ready for Phase 4 wallet integration (WALLET-01 enabled at contract level)
</success_criteria>

<output>
After completion, create `.planning/phases/01-smart-contract-foundation/01-03-SUMMARY.md`
</output>
