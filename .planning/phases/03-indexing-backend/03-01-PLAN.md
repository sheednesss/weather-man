---
phase: 03-indexing-backend
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - indexer-api/ponder.config.ts
  - indexer-api/ponder.schema.ts
  - indexer-api/src/MarketFactory.ts
  - indexer-api/src/PredictionMarket.ts
  - indexer-api/abis/MarketFactory.json
  - indexer-api/abis/PredictionMarket.json
  - indexer-api/package.json
  - indexer-api/.env.example
autonomous: true

must_haves:
  truths:
    - "Indexer discovers markets created by MarketFactory"
    - "Buy and Sell events update volume counters"
    - "GraphQL API returns markets sorted by volume"
  artifacts:
    - path: "indexer-api/ponder.config.ts"
      provides: "Chain and contract configuration with factory pattern"
      contains: "factory("
    - path: "indexer-api/ponder.schema.ts"
      provides: "Database schema for markets, trades, positions"
      contains: "onchainTable"
    - path: "indexer-api/src/MarketFactory.ts"
      provides: "MarketCreated event handler"
      contains: "ponder.on"
    - path: "indexer-api/src/PredictionMarket.ts"
      provides: "Buy/Sell event handlers with volume tracking"
      contains: "ponder.on"
  key_links:
    - from: "ponder.config.ts"
      to: "MarketFactory contract"
      via: "factory() discovers PredictionMarket addresses"
      pattern: "factory\\("
    - from: "PredictionMarket.ts"
      to: "ponder.schema.ts"
      via: "context.db updates markets.volume"
      pattern: "context\\.db"
---

<objective>
Set up Ponder indexer with schema and event handlers for prediction markets.

Purpose: Create the indexing foundation that tracks all on-chain market activity and exposes it via auto-generated GraphQL API.
Output: Working Ponder project that indexes MarketCreated, Buy, and Sell events with volume tracking.
</objective>

<execution_context>
@/Users/rasheedelhindi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rasheedelhindi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-indexing-backend/03-RESEARCH.md

# Contract ABIs needed for indexer
@contracts/src/MarketFactory.sol
@contracts/src/PredictionMarket.sol
@contracts/src/libraries/QuestionLib.sol
@contracts/src/libraries/CityLib.sol
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Ponder project with contract ABIs</name>
  <files>
    indexer-api/package.json
    indexer-api/ponder.config.ts
    indexer-api/abis/MarketFactory.json
    indexer-api/abis/PredictionMarket.json
    indexer-api/.env.example
  </files>
  <action>
    1. Create indexer-api/ directory at project root
    2. Initialize with `npm init ponder@latest` (accept defaults, TypeScript)
    3. Install additional deps: `npm install node-cache axios`
    4. Generate ABIs from contracts:
       - Run `cd contracts && forge build`
       - Copy MarketFactory ABI from `contracts/out/MarketFactory.sol/MarketFactory.json` (extract just the "abi" array)
       - Copy PredictionMarket ABI from `contracts/out/PredictionMarket.sol/PredictionMarket.json`
       - Place in indexer-api/abis/ directory
    5. Create ponder.config.ts with:
       - Base Sepolia chain (id: 84532) with RPC from env
       - MarketFactory contract with factory() pattern to discover PredictionMarket
       - Use factory() with MarketCreated event, parameter "market"
       - startBlock from env (default 0 for dev)
    6. Create .env.example with:
       - BASE_RPC_URL (Alchemy/Infura Base Sepolia)
       - MARKET_FACTORY_ADDRESS
       - START_BLOCK
       - DATABASE_URL (postgres:// for prod, leave empty for PGlite dev)

    Important: Use ES module imports. Ponder 0.16+ uses "ponder:registry" and "ponder:schema" imports.
  </action>
  <verify>
    - `cd indexer-api && npm run dev` starts without config errors
    - Console shows "Starting indexer..." or similar Ponder startup message
  </verify>
  <done>
    Ponder project initializes and connects to configured RPC (may show "waiting for events" if no contracts deployed).
  </done>
</task>

<task type="auto">
  <name>Task 2: Define schema and implement event handlers</name>
  <files>
    indexer-api/ponder.schema.ts
    indexer-api/src/MarketFactory.ts
    indexer-api/src/PredictionMarket.ts
  </files>
  <action>
    1. Create ponder.schema.ts with tables:
       - `markets`: id (hex, address), conditionId, questionId, cityId (text), lowerBound (int), upperBound (int), resolutionTime (bigint), createdAt (bigint), volume (bigint), yesPool (bigint), noPool (bigint), resolved (boolean)
       - `trades`: id (text, txHash-logIndex), marketId (hex), user (hex), amount (bigint), isYes (boolean), isBuy (boolean), timestamp (bigint)
       - `positions`: id (text, marketId-user-isYes), marketId (hex), user (hex), isYes (boolean), shares (bigint), costBasis (bigint)
       - Add indexes: markets.volume (for hot markets), markets.cityId, trades.marketId, trades.user, positions.user
       - Add relations: trades -> markets, positions -> markets

    2. Create src/MarketFactory.ts:
       - Handler for MarketCreated event
       - Extract cityId from questionId (bytes 24-25 after 0x = cityId byte, map 0->NYC, 1->CHICAGO, 2->MIAMI, 3->AUSTIN)
       - Extract lowerBound (bytes 20-24), upperBound (bytes 16-20) from questionId
       - Insert into markets table with volume=0, resolved=false

    3. Create src/PredictionMarket.ts:
       - Handler for Buy event:
         - Insert trade record (isBuy=true)
         - Update market volume += amount
         - Update or insert position (shares += amount, costBasis += amount)
       - Handler for Sell event:
         - Insert trade record (isBuy=false)
         - Update market volume (keep cumulative, don't subtract)
         - Update position (shares -= amount, costBasis -= proportional)

    QuestionId decoding (from QuestionLib.sol):
    - Byte layout: [0-3] marketType, [4-7] cityId, [8-11] lowerBound, [12-15] upperBound, [16-23] resolutionTime, [24-31] nonce
    - cityId is at byte offset 4 (bits 192-199)
    - lowerBound at byte offset 8 (bits 160-191), upperBound at byte offset 12 (bits 128-159)
    - resolutionTime at byte offset 16 (bits 64-127)
    - Parse using BigInt shifts: `BigInt(questionId) >> 192n & 0xFFn` for cityId
  </action>
  <verify>
    - TypeScript compiles: `npm run typecheck` or `npx tsc --noEmit`
    - Schema validates: `npm run dev` starts without schema errors
    - GraphQL playground accessible at http://localhost:42069 (Ponder default)
  </verify>
  <done>
    Schema defined with markets/trades/positions tables. Event handlers parse questionId and update volume. GraphQL API auto-generated.
  </done>
</task>

<task type="auto">
  <name>Task 3: Test with local Anvil fork and sample events</name>
  <files>
    indexer-api/.env.local
  </files>
  <action>
    1. Create .env.local for testing:
       - BASE_RPC_URL=http://127.0.0.1:8545 (Anvil)
       - MARKET_FACTORY_ADDRESS from Phase 1 deployment (or use a test address)
       - START_BLOCK=0

    2. Start Anvil fork in contracts directory:
       `cd contracts && anvil --fork-url $ALCHEMY_BASE_SEPOLIA_RPC`
       (If no Alchemy RPC, use local Anvil without fork for basic testing)

    3. In another terminal, run the indexer:
       `cd indexer-api && npm run dev`

    4. Verify GraphQL works:
       - Visit http://localhost:42069
       - Run query: `{ markets { items { id cityId volume } } }`
       - Should return empty array initially (no events yet)
       - Run query: `{ _meta { status } }` to verify indexer health

    5. If contracts are deployed, create a test market to verify indexing:
       - Use forge script or cast to create market on Anvil
       - Verify market appears in GraphQL response

    Note: Full integration test requires deployed contracts. For now, verify:
    - Ponder starts without errors
    - GraphQL endpoint responds
    - Schema is correctly reflected in GraphQL introspection
  </action>
  <verify>
    - GraphQL query `{ markets(orderBy: "volume", orderDirection: "desc") { items { id } } }` returns valid response
    - No TypeScript or runtime errors in Ponder console
  </verify>
  <done>
    Indexer runs against local/test RPC. GraphQL API returns market data sorted by volume (hot markets).
  </done>
</task>

</tasks>

<verification>
1. Ponder project structure exists in indexer-api/
2. `npm run dev` in indexer-api starts successfully
3. GraphQL endpoint at http://localhost:42069 responds
4. Query for markets with volume ordering works
5. Event handlers compile without TypeScript errors
</verification>

<success_criteria>
- Ponder indexer configured for MarketFactory and PredictionMarket contracts
- Schema includes markets, trades, positions with volume index
- MarketCreated handler extracts cityId from questionId
- Buy/Sell handlers update volume counters
- GraphQL API auto-generated and queryable
- Hot markets query (order by volume desc) works
</success_criteria>

<output>
After completion, create `.planning/phases/03-indexing-backend/03-01-SUMMARY.md`
</output>
