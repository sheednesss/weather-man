---
phase: 05-social-profiles
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - indexer-api/src/social/db.ts
  - indexer-api/src/social/schema.ts
  - indexer-api/src/social/middleware.ts
  - indexer-api/src/api/auth.ts
  - indexer-api/src/api/index.ts
  - indexer-api/drizzle.config.ts
  - indexer-api/package.json
autonomous: true

must_haves:
  truths:
    - "Backend can store and retrieve social data (profiles, follows, comments)"
    - "Users can authenticate via wallet signature (SIWE)"
    - "Authenticated sessions persist across requests"
  artifacts:
    - path: "indexer-api/src/social/schema.ts"
      provides: "Social data schema (profiles, follows, comments, predictions tables)"
      contains: "sqliteTable"
    - path: "indexer-api/src/social/db.ts"
      provides: "Drizzle database instance"
      contains: "drizzle"
    - path: "indexer-api/src/api/auth.ts"
      provides: "SIWE authentication routes"
      exports: ["default"]
    - path: "indexer-api/src/social/middleware.ts"
      provides: "Auth middleware for protected routes"
      exports: ["requireAuth"]
  key_links:
    - from: "indexer-api/src/api/auth.ts"
      to: "siwe"
      via: "SiweMessage verification"
      pattern: "SiweMessage"
    - from: "indexer-api/src/api/index.ts"
      to: "indexer-api/src/api/auth.ts"
      via: "Hono route mounting"
      pattern: "app\\.route.*auth"
---

<objective>
Set up SQLite database with Drizzle ORM for social features and implement SIWE (Sign-In With Ethereum) authentication.

Purpose: Establish the foundation for all social features - without this, no profiles, follows, or comments can be stored or authenticated.

Output: Working backend with social database schema and wallet-based authentication.
</objective>

<execution_context>
@/Users/rasheedelhindi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rasheedelhindi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-social-profiles/05-RESEARCH.md

@indexer-api/src/api/index.ts
@indexer-api/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create social database schema</name>
  <files>
    indexer-api/package.json
    indexer-api/src/social/schema.ts
    indexer-api/src/social/db.ts
    indexer-api/drizzle.config.ts
  </files>
  <action>
1. Install required packages in indexer-api/:
   ```bash
   npm install siwe drizzle-orm better-sqlite3 hono-sessions
   npm install -D drizzle-kit @types/better-sqlite3
   ```

2. Create `src/social/schema.ts` with tables:
   - `profiles`: address (PK, text), displayName (text), bio (text), createdAt (integer timestamp), updatedAt (integer timestamp)
   - `follows`: id (PK auto), followerAddress (text), followingAddress (text), createdAt (integer timestamp)
     - Add unique constraint on (followerAddress, followingAddress)
   - `comments`: id (PK auto), marketId (text), authorAddress (text), content (text), createdAt (integer timestamp)
   - `predictions`: id (PK auto), marketId (text), authorAddress (text), explanation (text), isYes (integer boolean), createdAt (integer timestamp)

   Use `sqliteTable` from `drizzle-orm/sqlite-core`. Use `integer('column', { mode: 'timestamp' })` for dates.
   IMPORTANT: Always store addresses as lowercase.

3. Create `src/social/db.ts`:
   - Import Database from `better-sqlite3`
   - Create SQLite database at `./social.db`
   - Export `socialDb` as drizzle instance with schema

4. Create `drizzle.config.ts` for migrations:
   ```typescript
   import type { Config } from 'drizzle-kit';
   export default {
     schema: './src/social/schema.ts',
     out: './drizzle',
     dialect: 'sqlite',
     dbCredentials: { url: './social.db' },
   } satisfies Config;
   ```

5. Run `npx drizzle-kit push` to create tables (use push for dev, not generate+migrate).
  </action>
  <verify>
    - `npm ls siwe drizzle-orm better-sqlite3 hono-sessions` shows all installed
    - `npx drizzle-kit push` succeeds without errors
    - `ls -la social.db` confirms database file exists
  </verify>
  <done>
    Social database schema created with profiles, follows, comments, predictions tables. Database file exists at indexer-api/social.db.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement SIWE authentication routes</name>
  <files>
    indexer-api/src/social/middleware.ts
    indexer-api/src/api/auth.ts
    indexer-api/src/api/index.ts
  </files>
  <action>
1. Create `src/social/middleware.ts`:
   - Export `requireAuth` middleware using `createMiddleware` from `hono/factory`
   - Check session for `address`, return 401 if missing
   - Set `c.set('address', address)` for downstream handlers

2. Create `src/api/auth.ts` as Hono sub-app with routes:
   - `GET /nonce`: Generate nonce via `generateNonce()` from siwe, store in session, return JSON
   - `POST /verify`: Parse {message, signature}, create SiweMessage, verify nonce matches session, verify signature using viem's `verifyMessage`, set session address (lowercase), clear nonce
   - `GET /session`: Return current session address or null
   - `POST /logout`: Clear session address

   Use `sessionMiddleware` from `hono-sessions` with `CookieStore`:
   - `encryptionKey`: Use `process.env.SESSION_SECRET` (must be 32+ chars)
   - `expireAfterSeconds`: 86400 (24 hours)
   - `cookieOptions`: { sameSite: 'Lax', path: '/', httpOnly: true }

   For signature verification, use viem:
   ```typescript
   import { createPublicClient, http } from 'viem';
   import { baseSepolia } from 'viem/chains';
   const client = createPublicClient({ chain: baseSepolia, transport: http() });
   const valid = await client.verifyMessage({ address, message, signature });
   ```

3. Update `src/api/index.ts`:
   - Import auth routes and CORS middleware
   - Add CORS middleware with `credentials: true` and explicit origin for localhost:5173
   - Mount auth routes at `/auth` path
   - Add SESSION_SECRET to .env.example if not exists

   IMPORTANT: Mount CORS and session middleware BEFORE other routes.
  </action>
  <verify>
    - `curl http://localhost:42069/auth/nonce` returns JSON with nonce
    - `curl http://localhost:42069/auth/session` returns `{"address":null}`
    - Check that CORS headers are present in response
  </verify>
  <done>
    SIWE authentication routes working: /auth/nonce, /auth/verify, /auth/session, /auth/logout. Sessions persist via encrypted cookies.
  </done>
</task>

</tasks>

<verification>
1. Database schema exists and is queryable:
   ```bash
   cd indexer-api && sqlite3 social.db ".tables"
   # Should show: profiles, follows, comments, predictions
   ```

2. Auth endpoints respond correctly:
   ```bash
   # Get nonce
   curl -c cookies.txt http://localhost:42069/auth/nonce
   # Check session (should be null)
   curl -b cookies.txt http://localhost:42069/auth/session
   ```

3. CORS headers present:
   ```bash
   curl -I -X OPTIONS http://localhost:42069/auth/nonce -H "Origin: http://localhost:5173"
   # Should include Access-Control-Allow-Credentials: true
   ```
</verification>

<success_criteria>
- SQLite database file exists with 4 tables (profiles, follows, comments, predictions)
- GET /auth/nonce returns unique nonce and sets session cookie
- GET /auth/session returns null for unauthenticated, address for authenticated
- CORS configured to allow credentials from frontend origin
</success_criteria>

<output>
After completion, create `.planning/phases/05-social-profiles/05-01-SUMMARY.md`
</output>
