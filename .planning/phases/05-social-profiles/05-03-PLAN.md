---
phase: 05-social-profiles
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - web/src/hooks/useAuth.ts
  - web/src/lib/api.ts
  - web/src/features/auth/SignInButton.tsx
  - web/src/components/layout/Header.tsx
  - web/package.json
autonomous: true

must_haves:
  truths:
    - "User can sign in with wallet signature"
    - "User can sign out"
    - "Auth state persists across page refresh"
    - "Sign in button shows in header"
  artifacts:
    - path: "web/src/hooks/useAuth.ts"
      provides: "SIWE authentication hook"
      exports: ["useAuth"]
    - path: "web/src/lib/api.ts"
      provides: "API client with credentials"
      exports: ["api", "API_URL"]
    - path: "web/src/features/auth/SignInButton.tsx"
      provides: "Sign in/out button component"
      exports: ["SignInButton"]
  key_links:
    - from: "web/src/hooks/useAuth.ts"
      to: "siwe"
      via: "SiweMessage creation"
      pattern: "SiweMessage"
    - from: "web/src/hooks/useAuth.ts"
      to: "wagmi"
      via: "useSignMessage hook"
      pattern: "useSignMessage"
    - from: "web/src/components/layout/Header.tsx"
      to: "web/src/features/auth/SignInButton.tsx"
      via: "Component import"
      pattern: "SignInButton"
---

<objective>
Implement frontend SIWE authentication with useAuth hook and SignInButton component integrated into the header.

Purpose: Enables users to authenticate with their wallet, which is required for all social write operations (profile updates, follows, comments).

Output: Working sign in/out flow visible in the application header.
</objective>

<execution_context>
@/Users/rasheedelhindi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rasheedelhindi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-social-profiles/05-RESEARCH.md
@.planning/phases/05-social-profiles/05-01-SUMMARY.md

@web/src/lib/wagmi.ts
@web/src/components/layout/Header.tsx
@web/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install siwe and create API client</name>
  <files>
    web/package.json
    web/src/lib/api.ts
  </files>
  <action>
1. Install siwe package in web/:
   ```bash
   npm install siwe
   ```

2. Create `src/lib/api.ts`:
   ```typescript
   export const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:42069';

   // Fetch wrapper that includes credentials for cookies
   export async function api<T>(
     endpoint: string,
     options: RequestInit = {}
   ): Promise<T> {
     const res = await fetch(`${API_URL}${endpoint}`, {
       ...options,
       credentials: 'include',
       headers: {
         'Content-Type': 'application/json',
         ...options.headers,
       },
     });

     if (!res.ok) {
       const error = await res.json().catch(() => ({ error: 'Request failed' }));
       throw new Error(error.error || 'Request failed');
     }

     return res.json();
   }
   ```

   The `credentials: 'include'` is CRITICAL for session cookies to be sent cross-origin.
  </action>
  <verify>
    - `npm ls siwe` in web/ shows package installed
    - `web/src/lib/api.ts` exists with credentials: 'include'
  </verify>
  <done>
    siwe installed, API client created with credentials support.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useAuth hook and SignInButton component</name>
  <files>
    web/src/hooks/useAuth.ts
    web/src/features/auth/SignInButton.tsx
    web/src/components/layout/Header.tsx
  </files>
  <action>
1. Create `src/hooks/useAuth.ts`:
   - Import `useAccount`, `useSignMessage` from wagmi
   - Import `SiweMessage` from siwe
   - Import `useMutation`, `useQuery`, `useQueryClient` from @tanstack/react-query
   - Import `api` from lib/api

   Implement:
   - `session` query: GET /auth/session, returns {address: string | null}
   - `signIn` mutation:
     1. Get nonce from GET /auth/nonce
     2. Create SiweMessage with: domain (window.location.host), address, statement ("Sign in to Weather Man"), uri (window.location.origin), version ("1"), chainId (84532 for Base Sepolia), nonce
     3. Call `prepareMessage()` to get message string
     4. Sign with `signMessageAsync({ message })`
     5. POST /auth/verify with {message, signature}
     6. On success, invalidate 'auth-session' query
   - `signOut` mutation: POST /auth/logout, invalidate 'auth-session' query

   Return: { isConnected, isAuthenticated, address, signIn, signOut, isSigningIn, error }

2. Create `src/features/auth/SignInButton.tsx`:
   - Import useAuth
   - Import useAccount from wagmi for wallet connection state
   - Show nothing if wallet not connected
   - Show "Sign In" button if connected but not authenticated
   - Show "Sign Out" button with truncated address if authenticated
   - Handle loading state during sign in
   - Style with Tailwind: compact button that fits in header

3. Update `src/components/layout/Header.tsx`:
   - Import SignInButton
   - Add SignInButton next to ConnectButton (or integrate into wallet section)
   - SignInButton should only show when wallet is connected

   Layout: [Logo/Nav] ... [SignInButton] [ConnectButton]
  </action>
  <verify>
    - `npm run build` in web/ succeeds without TypeScript errors
    - Open http://localhost:5173, connect wallet, see "Sign In" button appear
    - Click "Sign In", wallet prompts for signature
  </verify>
  <done>
    SIWE authentication working end-to-end. Users can sign in with wallet signature and sign out. Auth state visible in header.
  </done>
</task>

</tasks>

<verification>
1. Build check:
   ```bash
   cd web && npm run build
   ```

2. Manual flow test:
   - Start both servers (ponder dev, vite dev)
   - Open http://localhost:5173
   - Connect wallet via RainbowKit
   - See "Sign In" button appear
   - Click "Sign In"
   - Wallet prompts for message signature (EIP-191)
   - After signing, button changes to show truncated address + "Sign Out"
   - Refresh page - auth state persists (session cookie)
   - Click "Sign Out" - returns to "Sign In" state
</verification>

<success_criteria>
- siwe package installed in web/
- useAuth hook provides signIn/signOut mutations and session state
- SignInButton shows appropriate state (sign in / signed in + address)
- Sign in flow works: get nonce -> create SIWE message -> sign -> verify
- Session persists across page refresh
- Sign out clears session
</success_criteria>

<output>
After completion, create `.planning/phases/05-social-profiles/05-03-SUMMARY.md`
</output>
