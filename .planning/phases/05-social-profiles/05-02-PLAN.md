---
phase: 05-social-profiles
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - indexer-api/src/api/social.ts
  - indexer-api/src/api/index.ts
autonomous: true

must_haves:
  truths:
    - "Authenticated user can create/update their profile"
    - "Anyone can view a user's profile by address"
    - "Authenticated user can follow/unfollow other users"
    - "Authenticated user can see feed of followed users' predictions"
    - "Authenticated user can comment on markets"
    - "Anyone can view comments on a market"
    - "Authenticated user can save prediction with explanation"
  artifacts:
    - path: "indexer-api/src/api/social.ts"
      provides: "Social API routes"
      exports: ["default"]
  key_links:
    - from: "indexer-api/src/api/social.ts"
      to: "indexer-api/src/social/db.ts"
      via: "Drizzle queries"
      pattern: "socialDb"
    - from: "indexer-api/src/api/social.ts"
      to: "indexer-api/src/social/middleware.ts"
      via: "Auth middleware"
      pattern: "requireAuth"
    - from: "indexer-api/src/api/index.ts"
      to: "indexer-api/src/api/social.ts"
      via: "Hono route mounting"
      pattern: "app\\.route.*social"
---

<objective>
Implement REST API routes for all social features: profiles, follows, comments, predictions, and feed.

Purpose: Provides the backend API that the frontend will consume for all social interactions.

Output: Complete social API with CRUD operations for profiles, follows, comments, and predictions.
</objective>

<execution_context>
@/Users/rasheedelhindi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rasheedelhindi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-social-profiles/05-RESEARCH.md
@.planning/phases/05-social-profiles/05-01-SUMMARY.md

@indexer-api/src/social/schema.ts
@indexer-api/src/social/db.ts
@indexer-api/src/social/middleware.ts
@indexer-api/src/api/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create social API routes for profiles and follows</name>
  <files>
    indexer-api/src/api/social.ts
    indexer-api/src/api/index.ts
  </files>
  <action>
1. Create `src/api/social.ts` as Hono sub-app with these routes:

   **Profile routes:**
   - `GET /profiles/:address` (public): Get profile by address (lowercase the param). Return profile or default object with address and null fields if not found.
   - `PUT /profiles` (requireAuth): Update own profile. Accept {displayName, bio}. Use upsert (insert...onConflictDoUpdate). Validate displayName length 1-50 chars, bio max 500 chars.
   - `GET /profiles/:address/stats` (public): Return followerCount and followingCount for the address.

   **Follow routes:**
   - `POST /follow/:address` (requireAuth): Follow a user. Prevent self-follow (return 400). Use insert...onConflictDoNothing to prevent duplicates. Lowercase the address param.
   - `DELETE /follow/:address` (requireAuth): Unfollow a user. Delete the follow record.
   - `GET /followers/:address` (public): Get list of followers for an address. Join with profiles to include displayName.
   - `GET /following/:address` (public): Get list of users this address follows. Join with profiles to include displayName.
   - `GET /is-following/:address` (requireAuth): Check if current user follows the given address. Return {isFollowing: boolean}.

   Use drizzle-orm query functions: `eq`, `and`, `desc` from 'drizzle-orm'.
   IMPORTANT: Always lowercase addresses before storing or comparing.

2. Update `src/api/index.ts`:
   - Import social routes
   - Mount at `/social` path AFTER auth middleware is applied
  </action>
  <verify>
    - `curl http://localhost:42069/social/profiles/0xabc...` returns profile or default
    - `curl http://localhost:42069/social/followers/0xabc...` returns array
    - `curl http://localhost:42069/social/following/0xabc...` returns array
  </verify>
  <done>
    Profile and follow API routes working. Users can view profiles, follow/unfollow, and see follower lists.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create social API routes for comments, predictions, and feed</name>
  <files>
    indexer-api/src/api/social.ts
  </files>
  <action>
Add to existing `src/api/social.ts`:

   **Comment routes:**
   - `GET /markets/:marketId/comments` (public): Get comments for a market. Join with profiles for author displayName. Order by createdAt desc. Limit 100.
   - `POST /markets/:marketId/comments` (requireAuth): Add comment to market. Accept {content}. Validate content length 1-1000 chars. Return created comment.

   **Prediction routes:**
   - `GET /markets/:marketId/predictions` (public): Get predictions for a market. Join with profiles for author displayName. Order by createdAt desc.
   - `POST /markets/:marketId/predictions` (requireAuth): Add prediction with explanation. Accept {explanation, isYes}. Validate explanation length 1-2000 chars. Return created prediction.
   - `GET /profiles/:address/predictions` (public): Get all predictions by a user. Order by createdAt desc.

   **Feed route:**
   - `GET /feed` (requireAuth): Get predictions from followed users.
     - Join predictions with follows (predictions.authorAddress = follows.followingAddress)
     - Join with profiles for author displayName
     - Filter where follows.followerAddress = current user
     - Order by predictions.createdAt desc
     - Limit 50

   For all joins with profiles, use leftJoin so results still return even if profile doesn't exist (just displayName will be null).
  </action>
  <verify>
    - `curl http://localhost:42069/social/markets/0x123.../comments` returns array
    - `curl http://localhost:42069/social/markets/0x123.../predictions` returns array
    - (After auth) `curl -b cookies.txt http://localhost:42069/social/feed` returns array
  </verify>
  <done>
    Comments, predictions, and feed API routes working. Full social API complete.
  </done>
</task>

</tasks>

<verification>
1. Profile operations:
   ```bash
   # Get profile (should return default)
   curl http://localhost:42069/social/profiles/0x1234567890123456789012345678901234567890

   # Profile stats
   curl http://localhost:42069/social/profiles/0x1234567890123456789012345678901234567890/stats
   ```

2. Follow operations (requires auth - test with authenticated session):
   ```bash
   curl http://localhost:42069/social/followers/0x1234567890123456789012345678901234567890
   curl http://localhost:42069/social/following/0x1234567890123456789012345678901234567890
   ```

3. Comments and predictions:
   ```bash
   curl http://localhost:42069/social/markets/test-market/comments
   curl http://localhost:42069/social/markets/test-market/predictions
   ```
</verification>

<success_criteria>
- GET /social/profiles/:address returns profile or default object
- PUT /social/profiles updates authenticated user's profile (upsert)
- POST /social/follow/:address creates follow relationship
- DELETE /social/follow/:address removes follow relationship
- GET /social/followers/:address returns follower list with displayNames
- GET /social/markets/:id/comments returns comment list
- POST /social/markets/:id/comments creates comment (authenticated)
- POST /social/markets/:id/predictions creates prediction with explanation (authenticated)
- GET /social/feed returns followed users' predictions (authenticated)
</success_criteria>

<output>
After completion, create `.planning/phases/05-social-profiles/05-02-SUMMARY.md`
</output>
